<html>
<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
  <link href="http://code.google.com/apis/maps/documentation/javascript/examples/default.css" rel="stylesheet" type="text/css"/>
  <link href="stylesheets/layout.css" rel="stylesheet" type="text/css"/>
  <link href="stylesheets/style.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
  <script type="text/javascript">

    var initialLocation;
    var browserSupportFlag = new Boolean();
    var map;

    function initialize() {
      var myOptions = {
        zoom: 8,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
    <% @messages.each do |message|  %>
      var newLatLng = new google.maps.LatLng(<%=message["lat"]%>, <%=message["long"]%>);
      var marker<%=message["_id"]%> = new google.maps.Marker({
        position: newLatLng,
        map: map,
        title:"Hello World!"
      });
    <% end %>

      // Try W3C Geolocation method (Preferred)
      if (navigator.geolocation) {
        browserSupportFlag = true;
        navigator.geolocation.getCurrentPosition(function(position) {
          initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
          map.setCenter(initialLocation);
          google.maps.event.addListener(map, 'bounds_changed', function() {
            cityCircle.setCenter(map.getCenter());
            resetFormValues(map);
          });

        }, function() {
          handleNoGeolocation(browserSupportFlag);
        });
      } else if (google.gears) {
        // Try Google Gears Geolocation
        browserSupportFlag = true;
        var geo = google.gears.factory.create('beta.geolocation');
        geo.getCurrentPosition(function(position) {
          initialLocation = new google.maps.LatLng(position.latitude, position.longitude);
        }, function() {
          handleNoGeolocation(browserSupportFlag);
        });
      } else {
        // Browser doesn't support Geolocation
        browserSupportFlag = false;
        handleNoGeolocation(browserSupportFlag);
      }


    }

    function handleNoGeolocation(errorFlag) {
      if (errorFlag == true) {
        initialLocation = base_location;
        contentString = "Error: The Geolocation service failed.";
      } else {
        initialLocation = base_location;
        contentString = "Error: Your browser doesn't support geolocation";
      }
      map.setCenter(initialLocation);
    }


  </script>
</head>
<body onload="initialize()" class="sub">
<header id="header">
  <div id="logo">
    <img src="images/corrupt.png">
  </div>
</header>
<section id="page">
  <header class="page-header">
    <h1>Corruption Near You</h1>
  </header>
  <article>
    <h2>Locations of Reported Corruption</h2>

    <div id="corruption_map_container">
      <div id="map_canvas"></div>
    </div>
    <ul>
      <% @messages.each do |message| %>
        <% unless message.image.url.blank? %>
          <li>
            <img src="
              <% message.image.url %>">
          </li>
        <% end %>
        <li>
          <%= message["created_at"].strftime("%m/%y/%d %H:%M") %> <%= message["message"] %>
        </li>
      <% end %>
    </ul>
  </article>
  <footer id="footer">
    <p><a href="http://www.corrupt.mobi">Corrupt.mobi</a> is a
      <a href="http://www.hackforchange.com">HackforChange</a>
      project inspired by
      <a href="http://hackforchange.uservoice.com/forums/113515-hack-for-change/suggestions/1931313-help-save-monterrey-mexico-if-monterrey-falls-m">Help
        Save Monterrey, Mexico</a></p>
  </footer>
</section>
</body>
</html>
